name: Build PyPI Packages

on:
  push:
    branches:
      - '*'  # Run on all branches
  workflow_dispatch:  # Allow manual triggering

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      actvantage: ${{ steps.filter.outputs.actvantage }}
      rewact: ${{ steps.filter.outputs.rewact }}
      tools: ${{ steps.filter.outputs.tools }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for change detection
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            actvantage:
              - 'lerobot_policy_actvantage/**'
            rewact:
              - 'lerobot_policy_rewact/**'
            tools:
              - 'rewact_tools/**'

  build-actvantage:
    needs: detect-changes
    runs-on: ubuntu-latest
    # Only run if the package changed or manually triggered
    if: needs.detect-changes.outputs.actvantage == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        working-directory: lerobot_policy_actvantage
        run: |
          python -m build
      
      - name: Store artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lerobot_policy_actvantage-dist
          path: lerobot_policy_actvantage/dist/*
          retention-days: 7
      
      # Optional: Publish to PyPI (only on main/master branch and if credentials are set)
      - name: Publish to PyPI
        if: |
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
          secrets.PYPI_API_TOKEN != ''
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        working-directory: lerobot_policy_actvantage
        run: |
          python -m twine upload dist/* \
            --username __token__ \
            --password "$PYPI_API_TOKEN" \
            --skip-existing

  build-rewact:
    needs: detect-changes
    runs-on: ubuntu-latest
    # Only run if the package changed or manually triggered
    if: needs.detect-changes.outputs.rewact == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        working-directory: lerobot_policy_rewact
        run: |
          python -m build
      
      - name: Store artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lerobot_policy_rewact-dist
          path: lerobot_policy_rewact/dist/*
          retention-days: 7
      
      # Optional: Publish to PyPI (only on main/master branch and if credentials are set)
      - name: Publish to PyPI
        if: |
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
          secrets.PYPI_API_TOKEN != ''
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        working-directory: lerobot_policy_rewact
        run: |
          python -m twine upload dist/* \
            --username __token__ \
            --password "$PYPI_API_TOKEN" \
            --skip-existing

  build-tools:
    needs: detect-changes
    runs-on: ubuntu-latest
    # Only run if the package changed or manually triggered
    if: needs.detect-changes.outputs.tools == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        working-directory: rewact_tools
        run: |
          python -m build
      
      - name: Store artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rewact_tools-dist
          path: rewact_tools/dist/*
          retention-days: 7
      
      # Optional: Publish to PyPI (only on main/master branch and if credentials are set)
      - name: Publish to PyPI
        if: |
          (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
          secrets.PYPI_API_TOKEN != ''
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        working-directory: rewact_tools
        run: |
          python -m twine upload dist/* \
            --username __token__ \
            --password "$PYPI_API_TOKEN" \
            --skip-existing

